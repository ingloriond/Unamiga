#include <genesis.h>
#include <ym2612.h>

void patches() {
    int k;
    u8 patch_00[] = {
//0    1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
0x0f, 0x36, 0x74, 0x00, 0x01, 0x30, 0x34, 0x00, 0x01, 0x35, 0x74, 0x00, 0x01, 0x31, 0x34, 0x00, // 30
0x18, 0x19, 0X16, 0X00, 0X8a, 0x13, 0x17, 0x00, 0x8a, 0x37, 0x92, 0x00, 0x8a, 0x8b, 0x92, 0x00, // 40
0x1f, 0xdf, 0x1f, 0x00, 0x1f, 0x9f, 0x1f, 0x00, 0x1f, 0xdf, 0x12, 0x00, 0x1f, 0x9f, 0x1f, 0x00, // 50
0x12, 0x07, 0x00, 0x00, 0x0e, 0x09, 0x00, 0x00, 0x11, 0x06, 0x07, 0x00, 0x00, 0x06, 0x07, 0x00, // 60
0x00, 0x07, 0x00, 0x00, 0x07, 0x06, 0x00, 0x00, 0x0a, 0x06, 0x07, 0x00, 0x09, 0x08, 0x07, 0x00, // 70
0xff, 0x20, 0x00, 0x00, 0x1f, 0x10, 0x00, 0x00, 0x0f, 0x10, 0x38, 0x00, 0x0f, 0xf8, 0x38, 0x00, // 80
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 // 90
};

	u8 patch_10[] = {
//0    1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
0x74, 0x74, 0x00, 0x00, 0x34, 0x34, 0x00, 0x00, 0x74, 0x74, 0x00, 0x00, 0x34, 0x34, 0x00, 0x00, // 30
0x16, 0x16, 0X7f, 0X00, 0X17, 0x17, 0x7f, 0x00, 0x92, 0x92, 0x7f, 0x00, 0x92, 0x92, 0x7f, 0x00, // 40
0x1F, 0x1f, 0x00, 0x00, 0x1F, 0x1f, 0x00, 0x00, 0x12, 0x12, 0x00, 0x00, 0x1F, 0x1f, 0x00, 0x00, // 50
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x07, 0x00, 0x00, 0x07, 0x07, 0x00, 0x00, // 60
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x07, 0x00, 0x00, 0x07, 0x07, 0x00, 0x00, // 70
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x38, 0x00, 0x00, 0x38, 0x38, 0x00, 0x00, // 80
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00  // 90
};

	for( k=0; k<0x70; k++ ) {
        const u8 base=0x30;
    	YM2612_writeReg( 0, base+k, patch_00[k] );
        YM2612_writeReg( 1, base+k, patch_10[k] );
    }

    u8 patch_freq_00[] = {
    //  CH1   CH2   CH3
    	0x2d, 0x84, 0x5e, 0x00, // 0xA0
        0x33, 0x1a, 0x1a, 0x00, // 0xA4
        0x36, 0x20, 0x2c, 0x00, // 0xB0
        0xc0, 0xc0, 0xc0, 0x00 }; // 0xB4
    u8 patch_freq_10[] = {
    //  CH1   CH2   CH3
    	0xc5, 0x2d, 0x00, 0x00, // 0xA0
        0x13, 0x13, 0x00, 0x00, // 0xA4
        0x2c, 0x2c, 0x00, 0x00, // 0xB0
        0x80, 0x40, 0xc0, 0x00 }; // 0xB4
     for( k=7; k>=0; k-- ) {
     	YM2612_writeReg( 0, 0xA0+k, patch_freq_00[k] );
        YM2612_writeReg( 1, 0xA0+k, patch_freq_10[k] );
        YM2612_writeReg( 0, 0xB0+k, patch_freq_00[k+8] );
        YM2612_writeReg( 1, 0xB0+k, patch_freq_10[k+8] );
     }
}

void play() {
    int k;
    YM2612_writeReg( 0, 0x26, 0x0 );
    for( k=0; k<6; k++) {
        int ch = k;
        int wait=0;
        int cont;
                      // 0123456
        char msg[10] = "Canal ";
        msg[6] = 48+k+1;
        msg[7] = 0;
        VDP_drawText( msg, 10, 13);
        if( ch>2 ) ch++;
        for( cont=0; cont<2; cont++ ) {
            YM2612_writeReg( 0, 0x28, 0xf0 | ch );
            for( wait=0; wait<15; wait++ ) {
                YM2612_writeReg( 0, 0x27, 0x2A );
                while( (YM2612_read(0)&3) == 0 );
            }
            YM2612_writeReg( 0, 0x28, 0xf0 | ch );
        }
        YM2612_writeReg( 0, 0x28, ch );
    }
}

int main() {
    Z80_requestBus(1000);
    YM2612_reset();
    patches();
    while(1) play();
    return 0;
}
